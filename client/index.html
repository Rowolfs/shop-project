<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Каталог товаров (GraphQL)</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #cards { display: flex; flex-wrap: wrap; gap: 10px; }
    .card { border: 1px solid #ddd; padding: 10px; width: 180px; }
    #chat { border-top: 1px solid #ccc; margin-top: 40px; padding-top: 20px; }
    #messages { height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; }
    #chat-input { width: calc(100% - 90px); }
    #chat-send { width: 80px; }
  </style>
</head>
<body>
  <h1>Каталог товаров (GraphQL)</h1>
  <div id="cards">Загрузка карточек…</div>

  <div id="chat">
    <h2>Чат поддержки</h2>
    <div id="messages"></div>
    <input id="chat-input" placeholder="Сообщение…" />
    <button id="chat-send">Отправить</button>
  </div>

  <script>
    console.log('--- Page script loaded ---');

    // ------ GraphQL-запрос: только name и price ------
    const query = `{ products { name price } }`;
    fetch('/graphql', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    })
    .then(res => res.json())
    .then(({ data }) => {
      console.log('GraphQL: получены товары', data.products);
      const cards = document.getElementById('cards');
      cards.innerHTML = '';
      data.products.forEach(p => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `<h3>${p.name}</h3><p>Цена: $${p.price}</p>`;
        cards.appendChild(el);
      });
    })
    .catch(e => {
      console.error('GraphQL fetch error', e);
      document.getElementById('cards').innerText =
        'Ошибка загрузки GraphQL: ' + e.message;
    });

    // ------ WebSocket-чат ------
    console.log('Пытаюсь подключиться к ws://localhost:4000');
    const ws = new WebSocket('ws://localhost:4000');
    const msgContainer = document.getElementById('messages');

    ws.onopen = () => console.log('WebSocket: соединение открыто');
    ws.onerror = err => console.error('WebSocket: ошибка подключения', err);
    ws.onclose = () => console.log('WebSocket: соединение закрыто');

    ws.onmessage = async ev => {
      console.log('WebSocket: пришло сиро данные', ev.data);
      let dataStr;
      if (typeof ev.data === 'string') {
        dataStr = ev.data;
      } else if (ev.data instanceof Blob) {
        try {
          dataStr = await ev.data.text();
        } catch(err) {
          console.error('Ошибка чтения blob из WS:', err);
          return;
        }
      } else {
        console.warn('WS: неизвестный тип данных', ev.data);
        return;
      }
      console.log('WebSocket: пришло сообщение', dataStr);
      let msg;
      try {
        msg = JSON.parse(dataStr);
      } catch(e) {
        console.error('Не смог распарсить JSON из WS:', dataStr, e);
        return;
      }
      const d = document.createElement('div');
      d.textContent = `${msg.sender}: ${msg.text}`;
      msgContainer.appendChild(d);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    };

    document.getElementById('chat-send').addEventListener('click', () => {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) {
        console.warn('Пустое сообщение, не отправляю');
        return;
      }
      const msg = { sender: 'Покупатель', text };
      console.log('Отправляю через WS:', msg);
      ws.send(JSON.stringify(msg));
      input.value = '';
    });
  </script>
</body>
</html>